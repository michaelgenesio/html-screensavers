<!DOCTYPE html>
<html>
  <head>
    <title>World Hop</title>
    <meta charset="utf-8">
    <script src="lib/d3.v4.min.js"></script>
    <script src="lib/d3-geo.v1.min.js"></script>
    <script src="lib/topojson.min.js"></script>
    <style>
      body {
        background: #000;
        margin: 0;
        padding: 0;
        color: #fff;
      }

      .graticule {
        stroke: none;
        stroke-width: 0;
      }
      .boundary {
        fill: none;
        stroke: none;
      }
      .country {
        fill: #00CC00;
        stroke: #009900;
        stroke-width: 1px;
      }

      .line {
        fill: none;
        stroke: #ff0000;
        stroke-width: 5px;
      }
    </style>
  </head>
  <body>

    <div id="debug" style="white-space: pre;"></div>

    <div id="canvas-svg"></div>

    <script>
      (function() {

        const width = document.documentElement.clientWidth;
        const height = document.documentElement.clientHeight;

        const projection = d3.geoNaturalEarth1()
          .scale((width + 1) / 2 / Math.PI)
          .translate([width / 2, height / 2])
          .precision(.1);

        const path = d3.geoPath(projection);

        var graticule = d3.geoGraticule();

        var svg = d3.select("#canvas-svg").append("svg")
            .attr("width", width)
            .attr("height", height);

        svg.append("path")
            .datum(graticule)
            .attr("class", "graticule")
            .attr("d", path);

        svg.append("path")
           .datum(graticule)
           .attr("class", "choropleth")
           .attr("d", path);

        var g = svg.append("g")
          .attr("class", "countries");

        g.append("path")
         .datum({type: "LineString", coordinates: [[-180, 0], [-90, 0], [0, 0], [90, 0], [180, 0]]})
         .attr("class", "equator")
         .attr("d", path);

        d3.json("world-topo-min.json", function(error, world) {
          var countries = topojson.feature(world, world.objects.countries).features;

          var country = g.selectAll(".country").data(countries);

          country.enter()
            .insert("path")
            .attr("class", "country")
            .attr("d", path);

          g.append("path")
              .datum(topojson.mesh(world, world.objects.countries, function(a, b) { return a !== b; }))
              .attr("class", "boundary")
              .attr("d", path);


          const previousCountries = [];

          setInterval(function() {
            var randomCountry = countries[Math.floor(Math.random() * countries.length)];
            if (!randomCountry.geometry) {
              return;
            }

            console.log("Marking new random country: " + randomCountry.properties.name, randomCountry, path.centroid(randomCountry));

            svg.append("svg:circle")
              .attr("class", "circle")
              .attr("id", "country" + randomCountry.id)
              .attr("cx", path.centroid(randomCountry)[0])
              .attr("cy", path.centroid(randomCountry)[1])
              .attr("r", 100)
              .style("fill", "#f00")
              .style("opacity", "0.0")
              .transition()
                .duration(1000)
                .style("opacity", "1.0")
                .style("stroke", "#fff")
                .attr("r", 2);

            if (previousCountries.length > 0) {
              // draw a line from the previous country to the new one
              const origin = previousCountries[previousCountries.length - 1];
              const target = randomCountry;
              console.log("Drawing great circle line from " + origin.properties.name + " to " + target.properties.name, origin, target);
              const greatArc = {
                "type": "LineString",
                "coordinates": [
                  [d3.geoCentroid(origin)[0], d3.geoCentroid(origin)[1]],
                  [d3.geoCentroid(target)[0], d3.geoCentroid(target)[1]],
                ]
              };

              svg.append("path")
               .datum(greatArc)
               .attr("id", "lineFromCountry" + origin.id)
               .attr("d", path)
               .attr("class", "line")
               .attr("stroke-dasharray", "5,5")
               .attr("class", "line")
               .style("opacity", "0")
               .transition()
                 .delay(500)
                 .duration(1000)
                 .style("opacity", "0.5");
            }

            previousCountries.push(randomCountry);

            if (previousCountries.length > 10) {
              // trim list of points of interest
              const firstCountry = previousCountries.shift();
              console.log("Removing " + firstCountry.properties.name, firstCountry);
              d3.select("#country" + firstCountry.id)
                .transition()
                .duration(2000)
                .style("opacity", "0.0")
                .remove();
              d3.select("#lineFromCountry" + firstCountry.id)
                .transition()
                .duration(2000)
                .style("opacity", "0.0")
                .remove();
            }

          }, 5000);
        });
      })();

    </script>
  </body>
</html>